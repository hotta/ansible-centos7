---
- name: roles/openldap/tasks/main.yml
  assert: { that: true, quiet: true }

- name: Install LDAP support packages
  yum: 
    name:
      - openldap-servers
      - openldap-clients
      - migrationtools
      - ldapvi
  become: yes

- name: Start slapd
  systemd:
    name: slapd
    state: started
    enabled: true
  become: true

- name: Create directory for remote_tmp
  file:
    path: /var/lib/ldap/.ansible/tmp
    owner: ldap
    group: ldap
    mode: 0700
    recurse: true
  become: true

- name: Set DB_CONFIG
  copy:
    src: /usr/share/openldap-servers/DB_CONFIG.example
    dest: /var/lib/ldap/DB_CONFIG
    remote_src: true
  become: yes
  become_user: ldap

- name: Prepare work directory
  file:
    path: "{{ LDAP_WORKDIR }}"
    state: directory

- name: Check olcSuffix
  community.general.ldap_search:
    dn: olcDatabase={2}hdb,cn=config
    bind_dn: cn=config
    bind_pw: "{{ LDAP_BINDPW }}"
    attrs: [ 'olcSuffix' ]
  register: hdb
  tags: dump
  ignore_errors: true

# ok: [localhost] => {
#     "hdb": {
#         "changed": false,
#         "failed": false,
#         "results": [
#             {
#                 "dn": "olcDatabase={2}hdb,cn=config",
#                 "olcSuffix": "dc=example,dc=com"
#             }
#         ]
#     }
# }

- debug:
#   var: hdb.results.olcSuffix            - variable is not defined
#   var: hdb.results['olcSuffix']         - variable is not defined
#   var: "{{ hdb.results['olcSuffix'] }}" - list object has no attribute 'olcSuffix'
#   msg: "{{ hdb.results | string | regex_search('olcSuffix') }}"   => olcSuffix
#   msg: "{{ hdb.results.'olcSuffix' }}"  - template error
    var: hdb
  tags: dump

- set_fact:
    init: true

- set_fact:
    init: false
  when:
    - not hdb.failed
    - hdb.results[0]['olcSuffix'] == LDAP_BASEDN
  tags: dump

- name: Create root password hash
  command: slappasswd -s {{ LDAP_BINDPW }}
  register: olcRootPass
  when: init

- debug: var=olcRootPass.stdout
  when: init

- name: Check if 00_addpw exists
  stat:
    path: "{{ LDAP_WORKDIR }}/00_addpw.ldif"
  register: addpw
  when: init

- name: Create 00_addpw.ldif
  template:
    src: 00_addpw.ldif
    dest: "{{ LDAP_WORKDIR }}/"
  when: 
    - init
    - not addpw.stat.exists

# - name: Change Root password
#  community.general.ldap_entry:
#    dn: olcDatabase={0}config,cn=config
#    objectClass: olcDatabaseConfig
#    olcRootPW: "{{ olcRootPass.stdout }}"
#  become: true

- name: Set root passwd
  command: ldapmodify -H ldapi:// -f "{{ LDAP_WORKDIR }}/00_addpw.ldif"
  become: true
  when: init

- name: import schema ldifs
  command: ldapadd -x -D cn=config -w {{ LDAP_BINDPW }} -f /etc/openldap/schema/{{ item }}
  become: true
  loop:
    - core.ldif
    - cosine.ldif
    - nis.ldif
    - inetorgperson.ldif
  ignore_errors: true
  when: init

- name: Check if needed schemas exist.
  command: ldapsearch -x -LLL -D cn=config -w {{ LDAP_BINDPW }} -b cn=schema,cn=config dn
  register: schema
  when: init

- debug: var=schema.stdout
  when: init

- name: Create bind password hash
  command: slappasswd -s {{ LDAP_BINDPW }}
  register: olcBindPass
  when: init

- debug: var=olcBindPass.stdout
  when: init

- name: Check if 01_change_domain exists
  stat:
    path: "{{ LDAP_WORKDIR }}/01_change_domain.ldif"
  register: ch_domain
  when: init

- name: Create 01_change_domain.ldif
  template:
    src: 01_change_domain.ldif
    dest: "{{ LDAP_WORKDIR }}/"
  when:
    - init
    - not ch_domain.stat.exists

- name: Change domain
  command: ldapadd -x -D cn=config -w {{ LDAP_BINDPW }} -f "{{ LDAP_WORKDIR }}/01_change_domain.ldif"
  when: init

- name: Create 02_olcModuleLoad.ldif
  template:
    src: 02_olcModuleLoad.ldif
    dest: "{{ LDAP_WORKDIR }}/"
  when: init

- name: Install replicaiton module
  command: ldapadd -x -D cn=config -w {{ LDAP_BINDPW }} -f "{{ LDAP_WORKDIR }}/02_olcModuleLoad.ldif"
  when: init

- name: Create 03_olcServerID.ldif
  template:
    src: 03_olcServerID.ldif
    dest: "{{ LDAP_WORKDIR }}/"
  when: init

- name: Determine server IDs
  command: ldapadd -x -D cn=config -w {{ LDAP_BINDPW }} -f "{{ LDAP_WORKDIR }}/03_olcServerID.ldif"
  when: init

- name: Create 04_olcSyncRepl.ldif
  template:
    src: 04_olcSyncRepl.ldif
    dest: "{{ LDAP_WORKDIR }}/"
  when: init

- name: Set up replication
  command: ldapadd -x -D cn=config -w {{ LDAP_BINDPW }} -f "{{ LDAP_WORKDIR }}/04_olcSyncRepl.ldif"
  when: init

- name: Open firewall
  firewalld:
    service: ldap
    immediate: true
    permanent: true
    state: enabled
  become: true
